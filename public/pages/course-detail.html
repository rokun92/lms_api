<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Details - LMS</title>
    <link rel="stylesheet" href="/css/main.css">
    <style>
        .course-hero {
            background: var(--gradient-cosmic);
            padding: var(--space-3xl) 0;
            margin-bottom: var(--space-2xl);
            position: relative;
            overflow: hidden;
        }

        .course-hero::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(181, 55, 255, 0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }

        .course-hero h1 {
            color: white;
            font-size: 3rem;
            margin-bottom: var(--space-md);
            filter: drop-shadow(0 0 20px rgba(0, 0, 0, 0.3));
            position: relative;
            z-index: 1;
        }

        .course-hero p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.25rem;
            position: relative;
            z-index: 1;
        }

        .content-section {
            background: var(--glass-bg);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            padding: var(--space-2xl);
            margin-bottom: var(--space-xl);
            color: var(--text-bright);
        }

        .content-section h2 {
            color: var(--neon-cyan);
            margin-bottom: var(--space-lg);
            font-size: 1.75rem;
        }

        .purchase-card {
            position: sticky;
            top: var(--space-lg);
            background: var(--glass-bg);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            padding: var(--space-xl);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .modal-content {
            background: var(--glass-bg);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            padding: var(--space-2xl);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-xl);
        }

        .modal-header h3 {
            color: var(--text-bright);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-medium);
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: var(--neon-pink);
        }

        .form-group {
            margin-bottom: var(--space-lg);
        }

        .form-group label {
            display: block;
            margin-bottom: var(--space-sm);
            font-weight: 500;
            color: var(--text-bright);
        }

        .form-group input[type="text"],
        .form-group input[type="password"] {
            width: 100%;
            padding: var(--space-md);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-bright);
            font-size: 1rem;
            transition: all var(--transition-base);
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--neon-cyan);
            box-shadow: 0 0 10px rgba(0, 245, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            margin-bottom: var(--space-lg);
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--neon-cyan);
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            user-select: none;
            color: var(--text-medium);
        }

        /* Quiz Styles */
        input[type="radio"] {
            accent-color: var(--neon-cyan);
            width: 18px;
            height: 18px;
        }

        #courseContent h4 {
            color: var(--text-bright);
            margin-bottom: var(--space-md);
        }

        /* Exam Styles */
        .exam-question {
            margin-bottom: var(--space-xl);
            padding-bottom: var(--space-lg);
            border-bottom: 1px solid var(--glass-border);
        }

        .exam-question:last-child {
            border-bottom: none;
        }

        .exam-option {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            margin-bottom: var(--space-sm);
            padding: var(--space-sm);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: background 0.2s;
        }

        .exam-option:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .exam-option input[type="radio"] {
            margin: 0;
        }

        .result-score {
            font-size: 3rem;
            font-weight: 700;
            text-align: center;
            margin: var(--space-lg) 0;
            color: var(--text-bright);
        }

        .score-pass {
            color: var(--success);
        }

        .score-fail {
            color: var(--danger);
        }

        /* Custom scrollbar for modal */
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: var(--neon-cyan);
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb:hover {
            background: var(--neon-pink);
        }
    </style>
</head>

<body>
    <div id="navbar-container"></div>

    <div class="course-hero">
        <div class="container">
            <h1 id="courseTitle">Loading...</h1>
            <p id="courseDescription"></p>
        </div>
    </div>

    <div class="container">
        <div class="grid grid-3">
            <div id="mainContentColumn" style="grid-column: span 2;">
                <div class="content-section">
                    <h2>About This Course</h2>
                    <p id="fullDescription" class="text-muted"></p>
                </div>

                <div class="content-section" id="courseContentSection" style="display: none;">
                    <h2>Course Content</h2>
                    <div id="courseContent"></div>

                    <!-- Progress & Exam Section -->
                    <div id="progressSection"
                        style="margin-top: var(--space-xl); padding-top: var(--space-lg); border-top: 1px solid var(--glass-border);">
                        <h3>Your Progress</h3>
                        <div
                            style="background: rgba(255,255,255,0.05); height: 10px; border-radius: 5px; margin: var(--space-md) 0;">
                            <div id="progressBar"
                                style="height: 100%; width: 0%; background: var(--success); border-radius: 5px; transition: width 0.3s;">
                            </div>
                        </div>
                        <p id="progressText" class="text-muted mb-4">0% Completed</p>

                        <div id="examActionArea">
                            <!-- Buttons will be injected here -->
                        </div>
                    </div>
                </div>
            </div>

            <div id="sidebarColumn">
                <div class="purchase-card">
                    <div id="priceSection">
                        <h2 id="coursePrice" style="color: var(--success); margin-bottom: var(--spacing-md);"></h2>
                    </div>

                    <div id="actionSection"></div>

                    <div class="mt-3">
                        <h4>Includes:</h4>
                        <ul style="margin-left: var(--spacing-lg); color: var(--text-secondary);">
                            <li>Full lifetime access</li>
                            <li>Learn at your own pace</li>
                            <li>Certificate of Completion</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Exam Modal -->
    <div id="examModal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>Final Exam</h3>
                <button class="modal-close" onclick="closeExamModal()">&times;</button>
            </div>
            <div id="examBody">
                <form id="examForm">
                    <div id="examQuestions"></div>
                    <button type="submit" class="btn btn-primary mt-4" style="width: 100%;">Submit Answers</button>
                </form>
            </div>
        </div>
    </div>

    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/utils.js"></script>
    <script>
        const isAuth = auth.isAuthenticated();
        const role = auth.getUserRole();
        initPage(role);

        const urlParams = new URLSearchParams(window.location.search);
        const courseId = urlParams.get('id');

        if (!courseId) {
            showToast('Course not found', 'error');
            setTimeout(() => window.location.href = '/pages/courses.html', 1500);
        }

        let courseData = null;
        let isEnrolled = false;
        let examQuestions = [];

        async function loadCourse() {
            try {
                showLoading();
                const response = await api.getCourseById(courseId);
                courseData = response.data?.course;
                const course = courseData;

                document.getElementById('courseTitle').textContent = course.title;
                document.getElementById('courseDescription').textContent = course.description || '';
                document.getElementById('fullDescription').textContent = course.description || 'No description available.';
                document.getElementById('coursePrice').textContent = formatCurrency(course.price);

                // Check if enrolled
                if (isAuth && role === 'learner') {
                    try {
                        const contentResponse = await api.getCourseContent(courseId);
                        isEnrolled = true;
                        displayEnrolledContent(course, contentResponse.data);
                        updateProgressDisplay();
                    } catch (error) {
                        displayPurchaseView(course);
                    }
                } else {
                    displayPurchaseView(course);
                }

                hideLoading();
            } catch (error) {
                hideLoading();
                showToast('Failed to load course', 'error');
            }
        }

        function displayPurchaseView(course) {
            const actionSection = document.getElementById('actionSection');
            const isFree = parseFloat(course.price) === 0;

            if (!isAuth) {
                actionSection.innerHTML = `
                    <a href="/pages/login.html" class="btn btn-primary" style="width: 100%;">Login to ${isFree ? 'Enroll' : 'Purchase'}</a>
                `;
            } else if (role === 'learner') {
                if (isFree) {
                    actionSection.innerHTML = `
                        <button onclick="enrollFree()" class="btn btn-success" style="width: 100%;">Enroll Free</button>
                    `;
                } else {
                    actionSection.innerHTML = `
                        <button onclick="openPaymentModal()" class="btn btn-primary" style="width: 100%;">Purchase Course</button>
                    `;
                }
            } else {
                actionSection.innerHTML = `
                    <p class="text-muted text-center">Instructors cannot purchase courses</p>
                `;
            }
        }

        // Global variables for playlist
        let playlistFiles = [];

        function switchFile(index) {
            if (index < 0 || index >= playlistFiles.length) return;
            
            const media = document.getElementById('courseMedia');
            const file = playlistFiles[index];
            media.src = file.url;
            media.load();
            media.play();
            
            // Highlight current file
            document.querySelectorAll('.playlist-item').forEach((item, i) => {
                item.style.borderColor = i === index ? 'rgba(0,245,255,0.5)' : 'transparent';
                item.style.background = i === index ? 'rgba(0,245,255,0.2)' : 'rgba(0,245,255,0.1)';
            });
        }

        function displayEnrolledContent(course, contentData) {
            // Hide sidebar and expand main content
            document.getElementById('sidebarColumn').style.display = 'none';
            document.getElementById('mainContentColumn').style.gridColumn = '1 / -1';

            const contentSection = document.getElementById('courseContentSection');
            const contentDiv = document.getElementById('courseContent');
            contentSection.style.display = 'block';

            // Add content
            if (course.contentType === 'text') {
                contentDiv.innerHTML = `<div style="background: rgba(255,255,255,0.05); padding: var(--space-xl); border-radius: var(--radius-lg); white-space: pre-wrap;">${contentData.course.textContent}</div>`;
            } else if (course.contentType === 'video' || course.contentType === 'audio') {
                const files = contentData.course.fileUrls || [];
                if (files.length === 0) {
                    contentDiv.innerHTML = `<div style="text-align: center; padding: var(--space-2xl);">No media files available</div>`;
                } else if (files.length === 1) {
                    // Single file - show directly
                    const file = files[0];
                    contentDiv.innerHTML = `
                        <div style="background: black; border-radius: var(--radius-lg); overflow: hidden;">
                            <${course.contentType} id="courseMedia" controls style="width: 100%; max-width: 100%; display: block;">
                                <source src="${file.url}">
                            </${course.contentType}>
                        </div>
                    `;
                } else {
                    // Multiple files - create playlist
                    playlistFiles = files; // Store globally
                    
                    let playlistHTML = `
                        <div style="display: grid; grid-template-columns: 1fr 300px; gap: var(--space-lg);">
                            <div style="background: black; border-radius: var(--radius-lg); overflow: hidden;">
                                <${course.contentType} id="courseMedia" controls style="width: 100%; max-width: 100%; display: block;">
                                    <source src="${files[0].url}">
                                </${course.contentType}>
                            </div>
                            <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: var(--radius-lg); padding: var(--space-md); max-height: 400px; overflow-y: auto;">
                                <h4 style="margin-top: 0; margin-bottom: var(--space-md);">ðŸ“š Playlist (${files.length})</h4>
                                <div id="playlistContainer">
                    `;
                    
                    files.forEach((file, index) => {
                        playlistHTML += `
                            <div class="playlist-item" onclick="switchFile(${index})" style="padding: var(--space-sm); margin-bottom: var(--space-sm); background: rgba(0,245,255,0.1); border-radius: var(--radius-md); cursor: pointer; border: 2px solid transparent; transition: all 0.3s;">
                                <div style="font-size: 0.9rem; font-weight: 500;">${index + 1}. ${file.originalName || 'File ' + (index + 1)}</div>
                            </div>
                        `;
                    });
                    
                    playlistHTML += `
                                </div>
                            </div>
                        </div>
                    `;
                    contentDiv.innerHTML = playlistHTML;
                }
            }

            // Start progress tracking
            startProgressTracking(course);

            // Initial progress check
            updateProgressDisplay();
        }

        async function updateProgressDisplay() {
            try {
                const response = await api.getProgress(courseId);
                const data = response.data;

                // Update bar
                const percent = Math.min(100, Math.round(data.contentProgress || 0));
                document.getElementById('progressBar').style.width = `${percent}%`;
                document.getElementById('progressText').textContent = `${percent}% Content Completed`;

                const actionArea = document.getElementById('examActionArea');

                if (data.canGetCertificate) {
                    const scoreDisplay = data.examScore ? `<p class="mb-3">You Scored: <strong>${Number(data.examScore).toFixed(0)}%</strong></p>` : '';
                    actionArea.innerHTML = `
                        <div class="text-center">
                            <h3 class="text-success mb-3">ðŸŽ‰ Course Completed!</h3>
                            ${scoreDisplay}
                            <button onclick="completeCourse()" class="btn btn-success">Download Certificate</button>
                        </div>
                    `;
                } else if (data.canTakeExam) {
                    if (data.hasQuestions) {
                        actionArea.innerHTML = `
                            <div class="text-center">
                                <p class="mb-3">Content completed! You can now take the final exam.</p>
                                <button onclick="openExamModal()" class="btn btn-primary">Take Final Exam</button>
                            </div>
                        `;
                    } else {
                        // No exam logic (just direct completion if 100%)
                        actionArea.innerHTML = `
                            <button onclick="completeCourse()" class="btn btn-success" style="width: 100%;">Mark as Complete</button>
                        `;
                    }
                } else {
                    actionArea.innerHTML = `
                         <button class="btn btn-secondary" disabled style="width: 100%; opacity: 0.5;">Complete Content to Unlock Exam</button>
                    `;
                }
            } catch (error) {
                console.error('Failed to get progress', error);
            }
        }

        let progressInterval;
        let lastTime = Date.now();

        function startProgressTracking(course) {
            // Clear any existing interval
            if (progressInterval) clearInterval(progressInterval);

            // Handle text content progress
            if (course.contentType === 'text') {
                // Check if page is visible
                let isPageVisible = !document.hidden;
                document.addEventListener('visibilitychange', () => {
                    isPageVisible = !document.hidden;
                    if (isPageVisible) {
                        lastTime = Date.now();
                    }
                });

                progressInterval = setInterval(async () => {
                    if (!isPageVisible) return;

                    const now = Date.now();
                    const diff = Math.floor((now - lastTime) / 1000);
                    lastTime = now;

                    if (diff > 0) {
                        try {
                            // Update progress
                            await api.updateProgress(courseId, { timeSpentSeconds: diff });
                            // Update UI periodically
                            if (diff % 10 === 0) updateProgressDisplay();
                        } catch (error) {
                            console.error('Failed to update progress', error);
                        }
                    }
                }, 10000); // Check every 10 seconds
            }
            // Handle Video/Audio progress
            else if (course.contentType === 'video' || course.contentType === 'audio') {
                const mediaElement = document.querySelector(course.contentType);
                if (mediaElement) {
                    // Update progress every 5 seconds during playback
                    mediaElement.addEventListener('timeupdate', throttle(async () => {
                        try {
                            if (!mediaElement.paused && !mediaElement.ended) {
                                await api.updateProgress(courseId, {
                                    currentPositionSeconds: current,
                                    totalDurationSeconds: duration
                                });
                                updateProgressDisplay();
                            }
                        } catch (error) {
                            console.error('Failed to update progress', error);
                        }
                    }, 5000));

                    // Also update when paused or ended to capture exact spot
                    mediaElement.addEventListener('pause', async () => {
                        try {
                            await api.updateProgress(courseId, {
                                currentPositionSeconds: Math.floor(mediaElement.currentTime),
                                totalDurationSeconds: Math.floor(mediaElement.duration)
                            });
                            updateProgressDisplay();
                        } catch (error) {
                            console.error('Failed to update progress on pause', error);
                        }
                    });

                    mediaElement.addEventListener('ended', async () => {
                        setTimeout(updateProgressDisplay, 1000);
                    });
                }
            }
        }

        async function enrollFree() {
            try {
                showLoading();
                await api.purchaseCourse(courseId);
                hideLoading();
                showToast('Enrolled successfully!', 'success');
                setTimeout(() => location.reload(), 1500);
            } catch (error) {
                hideLoading();
                showToast(error.message || 'Enrollment failed', 'error');
            }
        }

        async function openPaymentModal() {
            try {
                showLoading();
                const response = await fetch('/api/payment/create-checkout-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ courseId })
                });

                const data = await response.json();
                hideLoading();

                if (data.success) {
                    window.location.href = data.data.url;
                } else {
                    showToast(data.message || 'Failed to initiate payment', 'error');
                }
            } catch (error) {
                hideLoading();
                console.error('Payment error:', error);
                showToast('Failed to initiate payment', 'error');
            }
        }

        async function openExamModal() {
            try {
                showLoading();
                const response = await api.getExam(courseId);
                hideLoading();

                examQuestions = response.data?.questions || [];
                if (examQuestions.length === 0) {
                    showToast('No questions found for this exam', 'warning');
                    return;
                }

                renderExamQuestions();
                const modal = document.getElementById('examModal');
                const modalContent = modal.querySelector('.modal-content');

                // Reset scroll position to top
                if (modalContent) {
                    modalContent.scrollTop = 0;
                }

                // Show modal
                modal.style.display = 'flex';

                // Prevent body scrolling
                document.body.style.overflow = 'hidden';
            } catch (error) {
                hideLoading();
                showToast(error.message || 'Failed to load exam', 'error');
            }
        }

        function closeExamModal() {
            document.getElementById('examModal').style.display = 'none';
            document.body.style.overflow = '';
        }

        function renderExamQuestions() {
            const container = document.getElementById('examQuestions');
            container.innerHTML = examQuestions.map((q, index) => `
                <div class="exam-question">
                    <p class="mb-3"><strong>${index + 1}. ${q.questionText}</strong> <span class="text-muted">(${q.points} pts)</span></p>
                    ${q.questionType === 'mcq' ? renderMcqOptions(q) : renderQuizInput(q)}
                </div>
            `).join('');
        }

        function renderMcqOptions(question) {
            return `
                <div class="options-group">
                    ${question.options.map(opt => `
                        <label class="exam-option">
                            <input type="radio" name="q_${question.id}" value="${opt.id}" required>
                            <span>${opt.text}</span>
                        </label>
                    `).join('')}
                </div>
            `;
        }

        function renderQuizInput(question) {
            return `
                <div class="form-group">
                    <input type="text" name="q_${question.id}" placeholder="Type your answer here..." required>
                </div>
            `;
        }

        document.getElementById('examForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const answers = {};
            const formData = new FormData(this);

            examQuestions.forEach(q => {
                const val = formData.get(`q_${q.id}`);
                if (val) answers[q.id] = val;
            });

            try {
                showLoading();
                const response = await api.submitExam(courseId, answers);
                hideLoading();

                const result = response.data;
                const passedClass = result.passed ? 'score-pass' : 'score-fail';
                const message = result.passed ? 'Congratulations! You passed.' : 'You did not pass. Please try again.';

                document.getElementById('examBody').innerHTML = `
                    <div class="text-center" style="padding: var(--space-xl);">
                        <h3 class="${passedClass}">${result.passed ? 'PASSED' : 'FAILED'}</h3>
                        <div class="result-score ${passedClass}">${Number(result.score).toFixed(0)}%</div>
                        <p class="mb-4">${message}</p>
                        <p>Total Points: ${result.pointsEarned} / ${result.totalPoints}</p>
                        <button onclick="location.reload()" class="btn btn-primary mt-4">Close & Refresh</button>
                    </div>
                `;
            } catch (error) {
                hideLoading();
                showToast(error.message || 'Failed to submit exam', 'error');
            }
        });

        async function completeCourse() {
            try {
                showLoading();
                const response = await api.completeCourse(courseId);
                hideLoading();
                showToast('Certificate generated successfully! Check your email.', 'success');
                if (response.data.certificateUrl) {
                    window.open(response.data.certificateUrl, '_blank');
                }
            } catch (error) {
                hideLoading();
                showToast(error.message || 'Failed to complete course', 'error');
            }
        }

        loadCourse();
    </script>
</body>

</html>